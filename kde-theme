#!/bin/bash
# kde-theme v8 (stable experimental)
#
# KDE Plasma theme + layout backup/restore utility
# Workflow for full theme switching:
#   - backup:  kde-theme backup <name>
#   - restore: kde-theme restore <name>         (theme only, NO global-theme auto-apply)
#   - layout:  kde-theme restore-layout <name>  (panels/widgets/Latte only)
#   - both:    kde-theme restore-all <name>     (APPLY GLOBAL THEME FIRST, then your overrides + layout)
#   - list:    kde-theme list
#   - uninstall: sudo kde-theme uninstall
#
# Behavior:
#   * Backups capture:
#       - kdeglobals, kwinrc, plasmarc, kcmstyle, kcminputrc, fonts, splash, etc.
#       - Plasma layout file (plasma-org.kde.plasma.desktop-appletsrc)
#       - ~/.local/share plasma*/icons/color-schemes/wallpapers/konsole/aurorae
#       - Kvantum config + themes
#       - Latte Dock config + layouts
#       - GTK 3/4 config, fontconfig, cursor selector (~/.icons/default)
#   * restore:
#       - Restores all of the above, but does NOT auto-apply the global LookAndFeel theme.
#   * restore-all:
#       - Extracts backup
#       - Applies saved global theme via lookandfeeltool (if available)
#       - Waits briefly
#       - Restores configs/assets (your overrides)
#       - Restores layout
#       - Restarts KWin + plasmashell for a clean layout reload

BASE_DIR="$HOME/kde-theme-backups"
DEBUG="${KDE_THEME_DEBUG:-0}"

log_debug() {
    [ "$DEBUG" = "1" ] && echo "[DEBUG] $*"
}

ensure_base_dir() { mkdir -p "$BASE_DIR"; }

# ---------- Helper: apply saved global theme (used ONLY in restore-all) ----------
apply_global_theme() {
    local backup_dir="$1"
    local theme_file="$backup_dir/global-theme-id.txt"

    if [ ! -f "$theme_file" ]; then
        log_debug "No global-theme-id.txt in backup; skipping global theme apply."
        return
    fi

    local THEME_ID
    THEME_ID="$(head -n1 "$theme_file" | tr -d '\r\n')"

    if [ -z "$THEME_ID" ]; then
        log_debug "Theme ID file empty; skipping."
        return
    fi

    echo "üé® Applying base global theme '$THEME_ID' via lookandfeeltool‚Ä¶"

    if ! command -v lookandfeeltool >/dev/null 2>&1; then
        echo "‚ö†Ô∏è lookandfeeltool not found; cannot auto-apply global theme."
        return
    fi

    lookandfeeltool -a "$THEME_ID" 2>/dev/null || \
    lookandfeeltool -a "$THEME_ID.desktop" 2>/dev/null || \
    echo "‚ö†Ô∏è Failed to apply theme through lookandfeeltool (theme may not be fully installed)."

    # Give KDE a moment to finish writing configs before we overwrite with our backup
    sleep 1
}

# ---------- BACKUP ----------
backup() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide a backup name."
        echo "Usage: kde-theme backup <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"
    mkdir -p "$BACKUP_DIR"

    echo "üîµ Backing up KDE theme/layout as '$NAME'‚Ä¶"
    echo "Backup directory: $BACKUP_DIR"

    # 0) Save current LookAndFeelPackage from kdeglobals (global theme ID)
    if [ -f "$HOME/.config/kdeglobals" ]; then
        local THEME_ID
        THEME_ID="$(sed -n 's/^LookAndFeelPackage=//p' "$HOME/.config/kdeglobals" | head -n1 | tr -d '\r\n')"
        if [ -n "$THEME_ID" ]; then
            echo "$THEME_ID" > "$BACKUP_DIR/global-theme-id.txt"
            echo "üé® Detected current global theme: '$THEME_ID'"
        fi
    fi

    # 1) Layout
    if [ -f "$HOME/.config/plasma-org.kde.plasma.desktop-appletsrc" ]; then
        log_debug "Backing up plasma layout file"
        cp "$HOME/.config/plasma-org.kde.plasma.desktop-appletsrc" "$BACKUP_DIR/"
    fi

    # 2) Core KDE/Plasma config files (extended)
    local cfg_files=(
        plasmarc
        kdeglobals
        kwinrc
        kwinrulesrc
        kscreenlockerrc
        systemsettingsrc
        konsolerc
        dolphinrc
        kcminputrc    # mouse/cursor
        kcmfonts      # fonts
        kcmstyle      # app style
        ksplashrc     # splash
    )

    for f in "${cfg_files[@]}"; do
        if [ -f "$HOME/.config/$f" ]; then
            log_debug "Backing up config file $f"
            cp "$HOME/.config/$f" "$BACKUP_DIR/"
        fi
    done

    # 3) Plasma & theme assets in ~/.local/share
    if [ -d "$HOME/.local/share" ]; then
        pushd "$HOME/.local/share" >/dev/null 2>&1

        local theme_dirs=(
            plasma
            plasma*
            icons
            color-schemes
            konsole
            aurorae
            wallpapers
        )

        for d in "${theme_dirs[@]}"; do
            for real in $d; do
                if [ -e "$real" ]; then
                    log_debug "Backing up theme directory $real"
                    cp -r "$real" "$BACKUP_DIR/" 2>/dev/null || true
                fi
            done
        done

        popd >/dev/null 2>&1
    fi

    # 4) Kvantum themes & config
    if [ -d "$HOME/.config/Kvantum" ]; then
        log_debug "Backing up Kvantum config"
        cp -r "$HOME/.config/Kvantum" "$BACKUP_DIR/Kvantum-config"
    fi
    if [ -d "$HOME/.local/share/Kvantum" ]; then
        log_debug "Backing up Kvantum themes"
        cp -r "$HOME/.local/share/Kvantum" "$BACKUP_DIR/Kvantum-themes"
    fi

    # 5) Latte Dock config & layouts
    if compgen -G "$HOME/.config/latte*" > /dev/null; then
        mkdir -p "$BACKUP_DIR/latte-config"
        log_debug "Backing up Latte Dock config"
        cp -r "$HOME"/.config/latte* "$BACKUP_DIR/latte-config/" 2>/dev/null || true
    fi
    if compgen -G "$HOME/.local/share/latte*" > /dev/null; then
        mkdir -p "$BACKUP_DIR/latte-share"
        log_debug "Backing up Latte Dock share data"
        cp -r "$HOME"/.local/share/latte* "$BACKUP_DIR/latte-share/" 2>/dev/null || true
    fi

    # 6) GTK config, fontconfig, cursor selector
    if [ -d "$HOME/.config/gtk-3.0" ]; then
        log_debug "Backing up GTK 3 settings (~/.config/gtk-3.0)"
        cp -r "$HOME/.config/gtk-3.0" "$BACKUP_DIR/gtk-3.0-config"
    fi
    if [ -d "$HOME/.config/gtk-4.0" ]; then
        log_debug "Backing up GTK 4 settings (~/.config/gtk-4.0)"
        cp -r "$HOME/.config/gtk-4.0" "$BACKUP_DIR/gtk-4.0-config"
    fi
    if [ -d "$HOME/.config/fontconfig" ]; then
        log_debug "Backing up fontconfig (~/.config/fontconfig)"
        cp -r "$HOME/.config/fontconfig" "$BACKUP_DIR/fontconfig-config"
    fi
    if [ -d "$HOME/.icons/default" ]; then
        log_debug "Backing up cursor default selector (~/.icons/default)"
        mkdir -p "$BACKUP_DIR/icons-meta"
        cp -r "$HOME/.icons/default" "$BACKUP_DIR/icons-meta/default"
    fi

    # 7) Tar snapshot of this backup
    tar -czf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR" "$NAME"

    echo "‚úÖ Backup complete!"
    echo " - Directory: $BACKUP_DIR"
    echo " - Archive:   $BASE_DIR/$NAME.tar.gz"
}

# ---------- Core restore of THEME FILES ONLY (no layout, no global-theme) ----------
restore_theme_files() {
    local BACKUP_DIR="$1"

    # 1) Core configs
    local cfg_files=(
        plasmarc
        kdeglobals
        kwinrc
        kwinrulesrc
        kscreenlockerrc
        systemsettingsrc
        konsolerc
        dolphinrc
        kcminputrc
        kcmfonts
        kcmstyle
        ksplashrc
    )

    mkdir -p "$HOME/.config"
    for f in "${cfg_files[@]}"; do
        if [ -f "$BACKUP_DIR/$f" ]; then
            log_debug "Restoring config file $f"
            cp "$BACKUP_DIR/$f" "$HOME/.config/"
        fi
    done

    # 2) ~/.local/share theme assets
    mkdir -p "$HOME/.local/share"
    local theme_dirs=(
        plasma
        plasma-desktop
        plasma-shell
        icons
        color-schemes
        konsole
        aurorae
        wallpapers
    )

    for d in "${theme_dirs[@]}"; do
        if [ -d "$BACKUP_DIR/$d" ]; then
            log_debug "Restoring theme directory $d"
            cp -r "$BACKUP_DIR/$d" "$HOME/.local/share/"
        fi
    done

    for d in "$BACKUP_DIR"/plasma*; do
        [ -d "$d" ] || continue
        log_debug "Restoring extra plasma directory $(basename "$d")"
        cp -r "$d" "$HOME/.local/share/"
    done

    # 3) Kvantum
    if [ -d "$BACKUP_DIR/Kvantum-config" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring Kvantum config"
        cp -r "$BACKUP_DIR/Kvantum-config" "$HOME/.config/Kvantum"
    fi
    if [ -d "$BACKUP_DIR/Kvantum-themes" ]; then
        mkdir -p "$HOME/.local/share"
        log_debug "Restoring Kvantum themes"
        cp -r "$BACKUP_DIR/Kvantum-themes" "$HOME/.local/share/Kvantum"
    fi

    # 4) Latte basic appearance (but NOT layout file; that‚Äôs handled separately)
    if [ -d "$BACKUP_DIR/latte-config" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring Latte Dock config"
        cp -r "$BACKUP_DIR/latte-config/"* "$HOME/.config/" 2>/dev/null || true
    fi
    if [ -d "$BACKUP_DIR/latte-share" ]; then
        mkdir -p "$HOME/.local/share"
        log_debug "Restoring Latte Dock share data"
        cp -r "$BACKUP_DIR/latte-share/"* "$HOME/.local/share/" 2>/dev/null || true
    fi

    # 5) GTK / fonts / cursor
    if [ -d "$BACKUP_DIR/gtk-3.0-config" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring GTK 3 settings"
        rm -rf "$HOME/.config/gtk-3.0"
        cp -r "$BACKUP_DIR/gtk-3.0-config" "$HOME/.config/gtk-3.0"
    fi
    if [ -d "$BACKUP_DIR/gtk-4.0-config" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring GTK 4 settings"
        rm -rf "$HOME/.config/gtk-4.0"
        cp -r "$BACKUP_DIR/gtk-4.0-config" "$HOME/.config/gtk-4.0"
    fi
    if [ -d "$BACKUP_DIR/fontconfig-config" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring fontconfig settings"
        rm -rf "$HOME/.config/fontconfig"
        cp -r "$BACKUP_DIR/fontconfig-config" "$HOME/.config/fontconfig"
    fi
    if [ -d "$BACKUP_DIR/icons-meta/default" ]; then
        mkdir -p "$HOME/.icons"
        log_debug "Restoring cursor default selector (~/.icons/default)"
        rm -rf "$HOME/.icons/default"
        cp -r "$BACKUP_DIR/icons-meta/default" "$HOME/.icons/default"
    fi
}

# ---------- RESTORE THEME (no global theme auto-apply) ----------
restore_theme() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide the backup name to restore."
        echo "Usage: kde-theme restore <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"

    if [ ! -d "$BACKUP_DIR" ] && [ ! -f "$BASE_DIR/$NAME.tar.gz" ]; then
        echo "‚ùå Backup '$NAME' not found in $BASE_DIR"
        exit 1
    fi

    echo "üü£ Restoring KDE theme from '$NAME' (no global theme auto-apply)‚Ä¶"

    if [ -f "$BASE_DIR/$NAME.tar.gz" ]; then
        log_debug "Extracting archive $BASE_DIR/$NAME.tar.gz"
        tar -xzf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR"
    fi

    restore_theme_files "$BACKUP_DIR"

    echo "üîÑ Restarting KWin‚Ä¶"
    qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true

    echo "‚úÖ Theme restore complete."
    echo
    echo "‚Ñπ Electron / Chromium apps (Chrome, Brave, VS Code, etc.)"
    echo "  draw their own titlebars (CSD). For better integration:"
    echo "    - Chrome: enable system title bar if available."
    echo "    - VS Code: set \"window.titleBarStyle\": \"native\" in settings."
    echo
}

# ---------- RESTORE LAYOUT ONLY ----------
restore_layout() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide the backup name to restore layout from."
        echo "Usage: kde-theme restore-layout <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"

    if [ ! -d "$BACKUP_DIR" ] && [ ! -f "$BASE_DIR/$NAME.tar.gz" ]; then
        echo "‚ùå Backup '$NAME' not found in $BASE_DIR"
        exit 1
    fi

    echo "‚ö†Ô∏è  Restoring layout from '$NAME'‚Ä¶"

    if [ -f "$BASE_DIR/$NAME.tar.gz" ]; then
        log_debug "Extracting archive for layout restore: $BASE_DIR/$NAME.tar.gz"
        tar -xzf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR"
    fi

    if [ -f "$BACKUP_DIR/plasma-org.kde.plasma.desktop-appletsrc" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring plasma layout file"
        cp "$BACKUP_DIR/plasma-org.kde.plasma.desktop-appletsrc" "$HOME/.config/"
    else
        echo "‚ùå No plasma-org.kde.plasma.desktop-appletsrc in backup; cannot restore layout."
        exit 1
    fi

    if [ -d "$BACKUP_DIR/latte-config" ]; then
        mkdir -p "$HOME/.config"
        log_debug "Restoring Latte layout config"
        cp -r "$BACKUP_DIR/latte-config/"* "$HOME/.config/" 2>/dev/null || true
    fi
    if [ -d "$BACKUP_DIR/latte-share" ]; then
        mkdir -p "$HOME/.local/share"
        log_debug "Restoring Latte layout share data"
        cp -r "$BACKUP_DIR/latte-share/"* "$HOME/.local/share/" 2>/dev/null || true
    fi

    echo "üîÑ Restarting Plasma shell for layout restore‚Ä¶"
    kquitapp5 plasmashell 2>/dev/null || true
    kstart5 plasmashell 2>/dev/null || true
    qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true

    echo "‚úÖ Layout restore complete."
}

# ---------- RESTORE BOTH (APPLY GLOBAL THEME FIRST) ----------
restore_all() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide the backup name."
        echo "Usage: kde-theme restore-all <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"

    if [ ! -d "$BACKUP_DIR" ] && [ ! -f "$BASE_DIR/$NAME.tar.gz" ]; then
        echo "‚ùå Backup '$NAME' not found in $BASE_DIR"
        exit 1
    fi

    echo "üü£ Restoring THEME + LAYOUT from '$NAME'‚Ä¶"

    if [ -f "$BASE_DIR/$NAME.tar.gz" ]; then
        log_debug "Extracting archive for restore-all: $BASE_DIR/$NAME.tar.gz"
        tar -xzf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR"
    fi

    # Step 1: apply base global theme
    apply_global_theme "$BACKUP_DIR"

    # Step 2: restore all theme configs/assets
    restore_theme_files "$BACKUP_DIR"

    # Step 3: restore layout
    restore_layout "$NAME"

    echo "‚úÖ Full theme + layout restore complete."
}

# ---------- LIST ----------
list_backups() {
    ensure_base_dir
    echo "üìÅ Available KDE theme backups in $BASE_DIR:"
    ls "$BASE_DIR"
}

# ---------- UNINSTALL ----------
uninstall_self() {
    echo "This will remove the KDE Theme Backup CLI + GUI from your system."
    echo

    if [ "$EUID" -ne 0 ]; then
        echo "‚ùå Please run as root:"
        echo "   sudo kde-theme uninstall"
        exit 1
    fi

    echo "üóë Removing binaries and files‚Ä¶"

    rm -f /usr/bin/kde-theme 2>/dev/null || true
    rm -f /usr/bin/kde-theme-gui 2>/dev/null || true
    rm -rf /usr/lib/kde-theme-backup 2>/dev/null || true
    rm -f /usr/share/applications/kde-theme-backup.desktop 2>/dev/null || true

    ICON_BASE="/usr/share/icons/hicolor"
    for size in 16x16 24x24 32x32 48x48 64x64 128x128 256x256 512x512 scalable; do
        rm -f "$ICON_BASE/$size/apps/kdethemebackup.png" 2>/dev/null || true
    done

    if command -v gtk-update-icon-cache >/dev/null 2>&1; then
        echo "üîÑ Updating icon cache‚Ä¶"
        gtk-update-icon-cache -f /usr/share/icons/hicolor >/dev/null 2>&1 || true
    fi

    if command -v update-desktop-database >/dev/null 2>&1; then
        echo "üîÑ Updating desktop database‚Ä¶"
        update-desktop-database >/dev/null 2>&1 || true
    fi

    echo "‚úÖ Uninstall complete!"
    echo "If this was installed via a .deb, you may also want to run:"
    echo "  sudo dpkg -r kde-theme-backup"
}

case "$1" in
    backup)
        backup "$2"
        ;;
    restore)
        restore_theme "$2"
        ;;
    restore-layout)
        restore_layout "$2"
        ;;
    restore-all)
        restore_all "$2"
        ;;
    list)
        list_backups
        ;;
    uninstall)
        uninstall_self
        ;;
    *)
        echo "KDE theme backup/restore utility v8"
        echo
        echo "Usage:"
        echo "  kde-theme backup <name>         # create a named backup (theme + layout + Kvantum + Latte + GTK + cursor)"
        echo "  kde-theme restore <name>        # restore THEME ONLY (no layout, no global-theme auto-apply)"
        echo "  kde-theme restore-layout <name> # restore widget/panel/Latte layout from backup"
        echo "  kde-theme restore-all <name>    # apply global theme + restore theme + layout"
        echo "  kde-theme list                  # list available backups"
        echo "  sudo kde-theme uninstall        # uninstall CLI + GUI from system"
        echo
        echo "Backups are stored in: $BASE_DIR"
        echo
        echo "Debug:"
        echo "  KDE_THEME_DEBUG=1 kde-theme restore-all <name>  # enable verbose debug logging"
        ;;
esac
