#!/bin/bash

# kde-theme: KDE Plasma theme + layout backup/restore utility 
# Snapshot current user setup and restore it on the SAME account.
# Features:
#   - Backup:  kde-theme backup <name>
#   - Restore: kde-theme restore <name>         (theme only)
#   - Layout:  kde-theme restore-layout <name>  (panels/widgets/Latte)
#   - Both:    kde-theme restore-all <name>
#   - List:    kde-theme list
#   - Uninstall: sudo kde-theme uninstall

BASE_DIR="$HOME/kde-theme-backups"

ensure_base_dir() {
    mkdir -p "$BASE_DIR"
}

# ---------- Helper: detect missing plasmoids from backup ----------
check_missing_plasmoids() {
    local backup_dir="$1"
    local cfg="$backup_dir/plasma-org.kde.plasma.desktop-appletsrc"

    if [ ! -f "$cfg" ]; then
        return
    fi

    echo "üîç Scanning for missing plasmoids in layout‚Ä¶"

    mapfile -t plugins < <(grep -oP '(?<=plugin=)[^\n]+' "$cfg" 2>/dev/null | sort -u)

    declare -A installed
    for dir in /usr/share/plasma/plasmoids "$HOME/.local/share/plasma/plasmoids"; do
        if [ -d "$dir" ]; then
            for p in "$dir"/*; do
                [ -d "$p" ] || continue
                installed["$(basename "$p")"]=1
            done
        fi
    done

    local missing=()
    for plugin in "${plugins[@]}"; do
        if [ -z "${installed[$plugin]}" ]; then
            missing+=("$plugin")
        fi
    done

    if [ "${#missing[@]}" -gt 0 ]; then
        echo "‚ö†Ô∏è  The following plasmoids from the backup layout are not installed on this system:"
        for m in "${missing[@]}"; do
            echo "   ‚Ä¢ $m"
        done
        echo "You may want to install these widgets (e.g. from Discover or store.kde.org) for a perfect restore."
    else
        echo "‚úÖ All plasmoids referenced in the layout appear to be installed."
    fi
}

# ---------- Helper: apply saved global theme ----------
apply_global_theme() {
    local backup_dir="$1"
    local theme_file="$backup_dir/global-theme-id.txt"

    if [ ! -f "$theme_file" ]; then
        return
    fi

    local THEME_ID
    THEME_ID="$(head -n1 "$theme_file" | tr -d '\r\n')"

    if [ -z "$THEME_ID" ]; then
        return
    fi

    echo "üé® Saved global theme in backup: '$THEME_ID'"

    local exists="no"
    if [ -d "$HOME/.local/share/plasma/look-and-feel/$THEME_ID" ] ||        [ -d "/usr/share/plasma/look-and-feel/$THEME_ID" ] ||        [ -f "$HOME/.local/share/plasma/look-and-feel/$THEME_ID.desktop" ] ||        [ -f "/usr/share/plasma/look-and-feel/$THEME_ID.desktop" ]; then
        exists="yes"
    fi

    if [ "$exists" = "no" ]; then
        echo "‚ö†Ô∏è Global theme '$THEME_ID' is not installed on this system."
        echo "   Install it (System Settings ‚Üí Global Theme ‚Üí Get New‚Ä¶)"
        read -r -p "After installing it, press ENTER to try applying it, or type 'skip' to continue: " ans

        if [ "$ans" = "skip" ] || [ "$ans" = "s" ]; then
            echo "Skipping global theme application."
            return
        fi

        if [ ! -d "$HOME/.local/share/plasma/look-and-feel/$THEME_ID" ] &&            [ ! -d "/usr/share/plasma/look-and-feel/$THEME_ID" ] &&            [ ! -f "$HOME/.local/share/plasma/look-and-feel/$THEME_ID.desktop" ] &&            [ ! -f "/usr/share/plasma/look-and-feel/$THEME_ID.desktop" ]; then
            echo "‚ùå Theme '$THEME_ID' still not found; skipping."
            return
        fi
    fi

    if command -v lookandfeeltool >/dev/null 2>&1; then
        echo "üîÑ Applying global theme '$THEME_ID' via lookandfeeltool‚Ä¶"
        lookandfeeltool -a "$THEME_ID" 2>/dev/null ||         lookandfeeltool -a "$THEME_ID.desktop" 2>/dev/null ||         echo "‚ö†Ô∏è Failed to apply theme with lookandfeeltool."
    else
        echo "‚ö†Ô∏è 'lookandfeeltool' not found; cannot auto-apply global theme."
    fi
}

# ---------- BACKUP ----------
backup() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide a backup name."
        echo "Usage: kde-theme backup <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"
    mkdir -p "$BACKUP_DIR"

    echo "üîµ Backing up KDE theme/layout as '$NAME'..."
    echo "Backup directory: $BACKUP_DIR"

    # 0) Save current LookAndFeelPackage from kdeglobals (global theme ID)
    if [ -f "$HOME/.config/kdeglobals" ]; then
        local THEME_ID
        THEME_ID="$(sed -n 's/^LookAndFeelPackage=//p' "$HOME/.config/kdeglobals" | head -n1 | tr -d '\r\n')"
        if [ -n "$THEME_ID" ]; then
            echo "$THEME_ID" > "$BACKUP_DIR/global-theme-id.txt"
            echo "üé® Detected current global theme: '$THEME_ID'"
        fi
    fi

    # 1) Layout (panels, widgets, activities)
    if [ -f "$HOME/.config/plasma-org.kde.plasma.desktop-appletsrc" ]; then
        cp "$HOME/.config/plasma-org.kde.plasma.desktop-appletsrc" "$BACKUP_DIR/"
    fi

    # 2) Core KDE/Plasma config files
    local cfg_files=(
        plasmarc
        kdeglobals
        kwinrc
        kwinrulesrc
        kscreenlockerrc
        systemsettingsrc
        konsolerc
        dolphinrc
    )

    for f in "${cfg_files[@]}"; do
        if [ -f "$HOME/.config/$f" ]; then
            cp "$HOME/.config/$f" "$BACKUP_DIR/"
        fi
    done

    # 3) Plasma & theme assets in ~/.local/share
    if [ -d "$HOME/.local/share" ]; then
        pushd "$HOME/.local/share" >/dev/null 2>&1

        local theme_dirs=(
            plasma
            plasma*
            icons
            color-schemes
            konsole
            aurorae
            wallpapers
        )

        for d in "${theme_dirs[@]}"; do
            for real in $d; do
                if [ -e "$real" ]; then
                    cp -r "$real" "$BACKUP_DIR/" 2>/dev/null || true
                fi
            done
        done

        popd >/dev/null 2>&1
    fi

    # 4) Kvantum themes & config
    if [ -d "$HOME/.config/Kvantum" ]; then
        cp -r "$HOME/.config/Kvantum" "$BACKUP_DIR/Kvantum-config"
    fi
    if [ -d "$HOME/.local/share/Kvantum" ]; then
        cp -r "$HOME/.local/share/Kvantum" "$BACKUP_DIR/Kvantum-themes"
    fi

    # 5) Latte Dock config & layouts
    if compgen -G "$HOME/.config/latte*" > /dev/null; then
        mkdir -p "$BACKUP_DIR/latte-config"
        cp -r "$HOME"/.config/latte* "$BACKUP_DIR/latte-config/" 2>/dev/null || true
    fi
    if compgen -G "$HOME/.local/share/latte*" > /dev/null; then
        mkdir -p "$BACKUP_DIR/latte-share"
        cp -r "$HOME"/.local/share/latte* "$BACKUP_DIR/latte-share/" 2>/dev/null || true
    fi

    # 6) Tar snapshot of this backup
    tar -czf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR" "$NAME"

    echo "‚úÖ Backup complete!"
    echo " - Directory: $BACKUP_DIR"
    echo " - Archive:   $BASE_DIR/$NAME.tar.gz"
}

# ---------- RESTORE THEME ONLY (no layout overwrite) ----------
restore_theme() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide the backup name to restore."
        echo "Usage: kde-theme restore <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"

    if [ ! -d "$BACKUP_DIR" ]; then
        echo "‚ùå Backup '$NAME' not found in $BASE_DIR"
        exit 1
    fi

    echo "üü£ Restoring KDE theme (without layout) from '$NAME'..."

    if [ -f "$BASE_DIR/$NAME.tar.gz" ]; then
        tar -xzf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR"
    fi

    # Apply global theme first (base look)
    apply_global_theme "$BACKUP_DIR"

    # 1) Core KDE config files
    local cfg_files=(
        plasmarc
        kdeglobals
        kwinrc
        kwinrulesrc
        kscreenlockerrc
        systemsettingsrc
        konsolerc
        dolphinrc
    )

    mkdir -p "$HOME/.config"
    for f in "${cfg_files[@]}"; do
        if [ -f "$BACKUP_DIR/$f" ]; then
            cp "$BACKUP_DIR/$f" "$HOME/.config/"
        fi
    done

    # 2) Plasma & theme assets
    mkdir -p "$HOME/.local/share"
    if [ -d "$BACKUP_DIR" ]; then
        local theme_dirs=(
            plasma
            plasma-desktop
            plasma-shell
            icons
            color-schemes
            konsole
            aurorae
            wallpapers
        )

        for d in "${theme_dirs[@]}"; do
            if [ -d "$BACKUP_DIR/$d" ]; then
                cp -r "$BACKUP_DIR/$d" "$HOME/.local/share/"
            fi
        done

        for d in "$BACKUP_DIR"/plasma*; do
            [ -d "$d" ] || continue
            cp -r "$d" "$HOME/.local/share/"
        done
    fi

    # 3) Kvantum
    if [ -d "$BACKUP_DIR/Kvantum-config" ]; then
        mkdir -p "$HOME/.config"
        cp -r "$BACKUP_DIR/Kvantum-config" "$HOME/.config/Kvantum"
    fi
    if [ -d "$BACKUP_DIR/Kvantum-themes" ]; then
        mkdir -p "$HOME/.local/share"
        cp -r "$BACKUP_DIR/Kvantum-themes" "$HOME/.local/share/Kvantum"
    fi

    # 4) Latte config/share
    if [ -d "$BACKUP_DIR/latte-config" ]; then
        mkdir -p "$HOME/.config"
        cp -r "$BACKUP_DIR/latte-config/"* "$HOME/.config/" 2>/dev/null || true
    fi
    if [ -d "$BACKUP_DIR/latte-share" ]; then
        mkdir -p "$HOME/.local/share"
        cp -r "$BACKUP_DIR/latte-share/"* "$HOME/.local/share/" 2>/dev/null || true
    fi

    # Apply global theme if saved (already applied earlier)
    # apply_global_theme "$BACKUP_DIR"

    echo "üîÑ Reloading KWin configuration‚Ä¶"
    qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true

    echo "‚úÖ Theme restore complete (layout untouched)."
}

# ---------- RESTORE LAYOUT ----------
restore_layout() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide the backup name to restore layout from."
        echo "Usage: kde-theme restore-layout <name>"
        exit 1
    fi

    ensure_base_dir
    local BACKUP_DIR="$BASE_DIR/$NAME"

    if [ ! -d "$BACKUP_DIR" ]; then
        echo "‚ùå Backup '$NAME' not found in $BASE_DIR"
        exit 1
    fi

    echo "‚ö†Ô∏è  WARNING: This will overwrite your current Plasma panel/widget layout"
    echo "    with the one from backup '$NAME'."
    echo "    Your newly added widgets/panels may be lost."

    check_missing_plasmoids "$BACKUP_DIR"

    if [ -f "$BASE_DIR/$NAME.tar.gz" ]; then
        tar -xzf "$BASE_DIR/$NAME.tar.gz" -C "$BASE_DIR"
    fi

    if [ -f "$BACKUP_DIR/plasma-org.kde.plasma.desktop-appletsrc" ]; then
        mkdir -p "$HOME/.config"
        cp "$BACKUP_DIR/plasma-org.kde.plasma.desktop-appletsrc" "$HOME/.config/"
    else
        echo "‚ùå No plasma-org.kde.plasma.desktop-appletsrc found in backup; cannot restore layout."
        exit 1
    fi

    if [ -d "$BACKUP_DIR/latte-config" ]; then
        mkdir -p "$HOME/.config"
        cp -r "$BACKUP_DIR/latte-config/"* "$HOME/.config/" 2>/dev/null || true
    fi
    if [ -d "$BACKUP_DIR/latte-share" ]; then
        mkdir -p "$HOME/.local/share"
        cp -r "$BACKUP_DIR/latte-share/"* "$HOME/.local/share/" 2>/dev/null || true
    fi

    echo "üîÑ Restarting Plasma shell for layout restore‚Ä¶"
    kquitapp5 plasmashell 2>/dev/null || true
    kstart5 plasmashell 2>/dev/null || true
    qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true

    echo "‚úÖ Layout restore complete."
}

# ---------- RESTORE BOTH ----------
restore_all() {
    local NAME="$1"
    if [ -z "$NAME" ]; then
        echo "‚ùå Please provide the backup name."
        echo "Usage: kde-theme restore-all <name>"
        exit 1
    fi

    echo "üü£ Restoring THEME + LAYOUT from '$NAME'..."
    restore_theme "$NAME"
    restore_layout "$NAME"
}

# ---------- LIST ----------
list_backups() {
    ensure_base_dir
    echo "üìÅ Available KDE theme backups in $BASE_DIR:"
    ls "$BASE_DIR"
}

# ---------- UNINSTALL (CLI) ----------
uninstall_self() {
    echo "This will remove the KDE Theme Backup CLI + GUI from your system."
    echo

    if [ "$EUID" -ne 0 ]; then
        echo "‚ùå Please run as root:"
        echo "   sudo kde-theme uninstall"
        exit 1
    fi

    echo "üóë Removing binaries and files‚Ä¶"

    rm -f /usr/bin/kde-theme 2>/dev/null || true
    rm -f /usr/bin/kde-theme-gui 2>/dev/null || true
    rm -rf /usr/lib/kde-theme-backup 2>/dev/null || true
    rm -f /usr/share/applications/kde-theme-backup.desktop 2>/dev/null || true

    ICON_BASE="/usr/share/icons/hicolor"
    for size in 16x16 24x24 32x32 48x48 64x64 128x128 256x256 512x512 scalable; do
        rm -f "$ICON_BASE/$size/apps/kde-theme-backup.png" 2>/dev/null || true
    done

    if command -v gtk-update-icon-cache >/dev/null 2>&1; then
        echo "üîÑ Updating icon cache‚Ä¶"
        gtk-update-icon-cache -f /usr/share/icons/hicolor >/dev/null 2>&1 || true
    fi

    if command -v update-desktop-database >/dev/null 2>&1; then
        echo "üîÑ Updating desktop database‚Ä¶"
        update-desktop-database >/dev/null 2>&1 || true
    fi

    echo "‚úÖ Uninstall complete!"
    echo "If this was installed via a .deb, you may also want to run:"
    echo "  sudo dpkg -r kde-theme-backup"
}

case "$1" in
    backup)
        backup "$2"
        ;;
    restore)
        restore_theme "$2"
        ;;
    restore-layout)
        restore_layout "$2"
        ;;
    restore-all)
        restore_all "$2"
        ;;
    list)
        list_backups
        ;;
    uninstall)
        uninstall_self
        ;;
    *)
        echo "KDE theme backup/restore utility (stable CLI)"
        echo
        echo "Usage:"
        echo "  kde-theme backup <name>         # create a named backup (theme + layout + Kvantum + Latte)"
        echo "  kde-theme restore <name>        # restore THEME ONLY (no widget/panel layout overwrite)"
        echo "  kde-theme restore-layout <name> # restore widget/panel/Latte layout from backup"
        echo "  kde-theme restore-all <name>    # restore theme + layout together"
        echo "  kde-theme list                  # list available backups"
        echo "  sudo kde-theme uninstall        # uninstall CLI + GUI from system"
        echo
        echo "Backups are stored in: $BASE_DIR"
        ;;
esac
